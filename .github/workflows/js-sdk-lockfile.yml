name: "JS SDK Lockfile Maintenance"

on:
  push:
    branches:
      - main
    paths:
      - "sdks/js/**"
      - ".github/workflows/js-sdk-lockfile.yml"

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: js-sdk-lockfile-${{ github.ref }}

jobs:
  update-lockfile:
    # Only run for Copybara-originated sync commits from the private repo.
    if: github.event_name == 'push' && contains(github.event.head_commit.message, 'GitOrigin-RevId')
    runs-on: ubuntu-latest

    steps:
      - name: "Checkout repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "Setup Node"
        uses: actions/setup-node@v4
        with:
          node-version: "22.x"
          cache: "yarn"
          cache-dependency-path: "sdks/js/yarn.lock"

      - name: "Update JS SDK lockfile"
        working-directory: sdks/js
        run: |
          corepack enable
          yarn install --mode update-lockfile
      - name: "Check for lockfile changes"
        id: lockfile
        run: |
          if git diff --quiet -- sdks/js/yarn.lock; then
            echo "Lockfile unchanged."
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "Lockfile updated."
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: "Create or update JS lockfile PR"
        if: steps.lockfile.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: "chore/js-lockfile-sync"
          commit-message: "[js] Update lockfile for synced public dependency changes"
          title: "[js] Update lockfile for synced public dependency changes"
          body: |
            This PR updates `sdks/js/yarn.lock` to match dependency changes synced from the private repository.

            - Source commit: ${{ github.sha }}
          add-paths: |
            sdks/js/yarn.lock
