[tasks]
build = "go build -tags=lightspark ./bin/operator"
build-oss = "go build ./bin/operator"
lint = "golangci-lint run && go run ./tools/entfieldlint/cmd/entfieldlint check"
# Sadly, `mise fmt` is a built in command
format = "golangci-lint fmt"
test-unit = """
  GRIPMOCK=true \
  GOFLAGS="-tags=lightspark" \
  gotestsum \
    --format testname \
    $(go list -tags=lightspark ./... | grep -v -E 'so/grpc_test|so/grpc_test_internal|so/tree') \
"""
test-unit-oss = """
  GRIPMOCK=true \
  gotestsum \
    --format testname \
    $(go list ./... | grep -v -E 'so/grpc_test|so/grpc_test_internal|so/tree')
"""
test-grpc = """
  gotestsum \
    --format testname \
    --packages="./so/grpc_test/... ./so/grpc_test_internal/..." \
    -- \
    -p 1 \
    -tags=lightspark
"""
test-grpc-oss = """
  gotestsum \
    --format testname \
    --packages="./so/grpc_test/... ./so/grpc_test_internal/..." \
    -- \
    -p 1
"""
test-grpc-minikube = """
  MINIKUBE_IP=$(minikube ip) \
  gotestsum \
    --format testname \
    --packages="./so/grpc_test/... ./so/grpc_test_internal/..." \
    -- \
    -p 1 \
    -tags=lightspark
"""
test-grpc-minikube-dbg = """
  MINIKUBE_IP=$(minikube ip) \
  gotestsum \
    --format standard-verbose \
    --packages="./so/grpc_test/... ./so/grpc_test_internal/..." \
    -- \
    -p 1 \
    -tags=lightspark
"""
test-grpc-minikube-oss = """
  MINIKUBE_IP=$(minikube ip) \
  gotestsum \
    --format testname \
    --packages="./so/grpc_test/... ./so/grpc_test_internal/..." \
    -- \
    -p 1
"""
atlas-hash="atlas migrate hash --dir 'file://so/ent/migrate/migrations'"
# Ent field deprecation lint - checks that fields are deprecated before removal
ent-field-lint = "go run ./tools/entfieldlint/cmd/entfieldlint check"
ent-field-diff = "go run ./tools/entfieldlint/cmd/entfieldlint diff"
